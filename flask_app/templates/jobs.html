{% extends "base.html" %}

{% block title %}Jobs - Backup Manager{% endblock %}

{% block content %}
<div class="max-w-7xl" x-data="{ createFormOpen: false }">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Backup Jobs</h1>
        <button @click="createFormOpen = !createFormOpen"
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
            <span x-show="!createFormOpen">+ Create New Job</span>
            <span x-show="createFormOpen">‚àí Cancel</span>
        </button>
    </div>

    <!-- Inline Create Job Form -->
    <div x-show="createFormOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 -translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 -translate-y-4"
         class="mb-6 bg-white rounded-lg shadow-xl p-6">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Create New Backup Job</h2>

        <form hx-post="/jobs/create"
              hx-target="#jobs-content"
              hx-swap="outerHTML"
              hx-on::before-request="
                const deleteCheckbox = this.querySelector('#delete_source_after');
                const confirmCheckbox = this.querySelector('#deletion_confirmed');
                if (deleteCheckbox && deleteCheckbox.checked) {
                  if (!confirmCheckbox || !confirmCheckbox.checked) {
                    alert('‚ö†Ô∏è You must check the confirmation checkbox to enable source deletion!');
                    event.preventDefault();
                    return false;
                  }
                }
                return true;
              "
              hx-on::after-request="if(event.detail.successful && event.detail.xhr.responseURL.includes('/jobs/create')) { createFormOpen = false; this.reset(); document.getElementById('deletion-options').innerHTML = ''; }"
              class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Job Name -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                        Job Name *
                    </label>
                    <input type="text"
                           id="name"
                           name="name"
                           required
                           placeholder="e.g., Photos Backup"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>

                <!-- Job Type -->
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">
                        Backup Type *
                    </label>
                    <select id="type"
                            name="type"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="rsync">rsync (local)</option>
                        <option value="rclone">rclone (cloud)</option>
                    </select>
                </div>

                <!-- Source Path -->
                <div>
                    <label for="source" class="block text-sm font-medium text-gray-700 mb-1">
                        Source Path *
                    </label>
                    <input type="text"
                           id="source"
                           name="source"
                           required
                           placeholder="/Users/you/Photos or gdrive:Photos"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>

                <!-- Destination Path -->
                <div>
                    <label for="dest" class="block text-sm font-medium text-gray-700 mb-1">
                        Destination Path *
                    </label>
                    <input type="text"
                           id="dest"
                           name="dest"
                           required
                           placeholder="/Volumes/Backup/Photos"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>

                <!-- Bandwidth Limit -->
                <div>
                    <label for="bandwidth_limit" class="block text-sm font-medium text-gray-700 mb-1">
                        Bandwidth Limit (KB/s)
                    </label>
                    <input type="number"
                           id="bandwidth_limit"
                           name="bandwidth_limit"
                           min="0"
                           value="0"
                           placeholder="0 = unlimited"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
            </div>

            <!-- Source Deletion Settings -->
            <div class="border-t border-gray-200 pt-4 mt-4">
                <div class="flex items-center">
                    <input type="checkbox"
                           id="delete_source_after"
                           name="delete_source_after"
                           value="true"
                           class="mr-3 w-4 h-4 text-red-600 focus:ring-red-500 cursor-pointer"
                           onchange="
                             fetch('/jobs/deletion-ui?delete_source_after=' + this.checked)
                               .then(r => r.text())
                               .then(html => document.getElementById('deletion-options').innerHTML = html)
                               .catch(e => {
                                 console.error('Failed to load deletion options:', e);
                                 document.getElementById('deletion-options').innerHTML = '<div class=&quot;text-red-700 text-sm&quot;>Failed to load options. Please try again.</div>';
                               });
                           ">
                    <label for="delete_source_after" class="text-sm font-medium text-gray-700 cursor-pointer">
                        üóëÔ∏è Delete source files after successful backup
                    </label>
                    <span class="deletion-options-indicator htmx-indicator ml-2 text-xs text-gray-400">Loading‚Ä¶</span>
                </div>
                <p class="ml-7 mt-1 text-xs text-red-600">
                    ‚ö†Ô∏è WARNING: This will permanently delete source files after backup completes
                </p>

                <!-- Deletion Options (populated via HTMX when checkbox is checked) -->
                <div id="deletion-options"
                     class="mt-3"
                     role="region"
                     aria-live="polite"
                     aria-label="Deletion options"></div>
            </div>

            <div class="flex gap-3 pt-4">
                <button type="submit"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                    Create Job
                </button>
                <button type="button"
                        @click="createFormOpen = false; $el.closest('form').reset(); document.getElementById('deletion-options').innerHTML = '';"
                        class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition text-sm font-medium">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Jobs Content (Flash Messages + Job List) -->
    <div id="jobs-content">
        {% include 'partials/jobs_content.html' %}
    </div>
</div>

<!-- WebSocket connection for real-time updates -->
<script>
    // Connect to WebSocket for real-time job updates
    const socket = io();

    socket.on('connect', function() {
        console.log('Connected to WebSocket');
    });

    socket.on('job_update', function(data) {
        console.log('Job update received:', data);
        // Update the specific job card with new progress
        const jobCard = document.querySelector(`[data-job-id="${data.job_id}"]`);
        if (jobCard) {
            // Update progress bar
            const progressBar = jobCard.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = data.percent + '%';
                progressBar.textContent = data.percent + '%';
            }

            // Update status badge if status changed
            if (data.status) {
                const statusBadge = jobCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = 'status-badge px-3 py-1 rounded-full text-sm font-semibold ' + getStatusClass(data.status);
                    statusBadge.textContent = data.status;
                }
            }

            // Update transfer info
            if (data.bytes_transferred !== undefined) {
                const transferInfo = jobCard.querySelector('.transfer-info');
                if (transferInfo) {
                    transferInfo.textContent = formatBytes(data.bytes_transferred) + ' / ' + formatBytes(data.total_bytes);
                }
            }

            // Update speed
            if (data.speed_bytes !== undefined) {
                const speedInfo = jobCard.querySelector('.speed-info');
                if (speedInfo) {
                    speedInfo.textContent = formatBytes(data.speed_bytes) + '/s';
                }
            }

            // Update ETA
            if (data.eta_seconds !== undefined) {
                const etaInfo = jobCard.querySelector('.eta-info');
                if (etaInfo) {
                    etaInfo.textContent = 'ETA: ' + formatDuration(data.eta_seconds);
                }
            }

            // Update deletion progress
            if (data.deletion && data.deletion.enabled) {
                const deletionProgress = jobCard.querySelector('.deletion-progress');
                if (deletionProgress) {
                    const phaseText = deletionProgress.querySelector('.deletion-phase-text');
                    const filesCount = deletionProgress.querySelector('.deletion-files-count');
                    const bytesCount = deletionProgress.querySelector('.deletion-bytes-count');

                    // Update phase-specific text
                    if (phaseText) {
                        let phaseHtml = '';
                        const phase = data.deletion.phase;

                        if (phase === 'transfer') {
                            phaseHtml = '<span class="text-yellow-700">Transferring files...</span>';
                        } else if (phase === 'verifying') {
                            phaseHtml = '<span class="text-blue-700">üîç Verifying backup integrity...</span>';
                        } else if (phase === 'deleting') {
                            const files = data.deletion.files_deleted || 0;
                            const mb = (data.deletion.bytes_deleted / 1024 / 1024).toFixed(2) || '0.00';
                            phaseHtml = `<span class="text-red-700">üóëÔ∏è Deleting source files... (${files} files, ${mb} MB)</span>`;
                        } else if (phase === 'completed') {
                            const files = data.deletion.files_deleted || 0;
                            phaseHtml = `<span class="text-green-700">‚úÖ Deletion completed (${files} files deleted)</span>`;
                        } else if (phase === 'failed') {
                            phaseHtml = '<span class="text-red-700">‚ùå Deletion failed</span>';
                        }

                        phaseText.innerHTML = phaseHtml;
                    }

                    // Update counters separately if they exist (for deleting phase)
                    if (filesCount && data.deletion.files_deleted !== undefined) {
                        filesCount.textContent = data.deletion.files_deleted;
                    }
                    if (bytesCount && data.deletion.bytes_deleted !== undefined) {
                        bytesCount.textContent = (data.deletion.bytes_deleted / 1024 / 1024).toFixed(2);
                    }
                }
            }
        }
    });

    function getStatusClass(status) {
        const statusClasses = {
            'pending': 'bg-gray-200 text-gray-700',
            'running': 'bg-blue-100 text-blue-700',
            'paused': 'bg-yellow-100 text-yellow-700',
            'completed': 'bg-green-100 text-green-700',
            'failed': 'bg-red-100 text-red-700'
        };
        return statusClasses[status] || 'bg-gray-200 text-gray-700';
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function formatDuration(seconds) {
        if (seconds === 0) return '0s';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return h + 'h ' + m + 'm';
        if (m > 0) return m + 'm ' + s + 's';
        return s + 's';
    }
</script>
{% endblock %}

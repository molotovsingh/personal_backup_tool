{% extends "base.html" %}

{% block title %}Jobs - Backup Manager{% endblock %}

{% block content %}
<div class="max-w-7xl">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Backup Jobs</h1>
        <button onclick="document.getElementById('create-job-modal').classList.remove('hidden')"
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
            + Create New Job
        </button>
    </div>

    <!-- Jobs Content (Flash Messages + Job List) -->
    <div id="jobs-content">
        {% include 'partials/jobs_content.html' %}
    </div>

    <!-- Create Job Modal -->
    <div id="create-job-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Create Backup Job</h2>
                    <button onclick="document.getElementById('create-job-modal').classList.add('hidden')"
                            class="text-gray-500 hover:text-gray-700 text-2xl">
                        &times;
                    </button>
                </div>

                <form hx-post="/jobs/create"
                      hx-target="#jobs-content"
                      hx-swap="outerHTML"
                      hx-on::after-request="if(event.detail.successful) { document.getElementById('create-job-modal').classList.add('hidden'); this.reset(); }">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="space-y-4">
                        <!-- Job Name -->
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                                Job Name *
                            </label>
                            <input type="text"
                                   id="name"
                                   name="name"
                                   required
                                   placeholder="e.g., Photos Backup"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- Job Type -->
                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-700 mb-2">
                                Backup Type *
                            </label>
                            <select id="type"
                                    name="type"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="rsync">rsync (local to local)</option>
                                <option value="rclone">rclone (cloud/remote)</option>
                            </select>
                        </div>

                        <!-- Source Path -->
                        <div>
                            <label for="source" class="block text-sm font-medium text-gray-700 mb-2">
                                Source Path *
                            </label>
                            <input type="text"
                                   id="source"
                                   name="source"
                                   required
                                   placeholder="e.g., /Users/you/Photos or gdrive:Photos"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-sm text-gray-500">
                                For rsync: local path (e.g., /Users/you/Documents)<br>
                                For rclone: remote path (e.g., gdrive:folder)
                            </p>
                        </div>

                        <!-- Destination Path -->
                        <div>
                            <label for="dest" class="block text-sm font-medium text-gray-700 mb-2">
                                Destination Path *
                            </label>
                            <input type="text"
                                   id="dest"
                                   name="dest"
                                   required
                                   placeholder="e.g., /Volumes/Backup/Photos"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-sm text-gray-500">
                                Where the backup will be stored
                            </p>
                        </div>

                        <!-- Bandwidth Limit -->
                        <div>
                            <label for="bandwidth_limit" class="block text-sm font-medium text-gray-700 mb-2">
                                Bandwidth Limit (KB/s)
                            </label>
                            <input type="number"
                                   id="bandwidth_limit"
                                   name="bandwidth_limit"
                                   min="0"
                                   value="0"
                                   placeholder="0 = unlimited"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-sm text-gray-500">
                                0 means no limit
                            </p>
                        </div>

                        <!-- Source Deletion Settings -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <div class="mb-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox"
                                           id="delete_source_after"
                                           name="delete_source_after"
                                           value="true"
                                           class="mr-3 w-5 h-5 text-red-600 focus:ring-red-500"
                                           hx-get="/jobs/deletion-ui?delete_source_after=true"
                                           hx-trigger="change"
                                           hx-target="#deletion-options"
                                           hx-swap="innerHTML"
                                           onclick="if(!this.checked) document.getElementById('deletion-options').innerHTML = '';">
                                    <span class="text-sm font-medium text-gray-700">
                                        üóëÔ∏è Delete source files after successful backup
                                    </span>
                                </label>
                                <p class="ml-8 mt-1 text-sm text-red-600">
                                    ‚ö†Ô∏è WARNING: This will permanently delete source files after backup completes
                                </p>
                            </div>

                            <!-- Deletion Options (populated via HTMX when checkbox is checked) -->
                            <div id="deletion-options"></div>
                        </div>
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button type="submit"
                                class="flex-1 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                            Create Job
                        </button>
                        <button type="button"
                                onclick="document.getElementById('create-job-modal').classList.add('hidden'); this.closest('form').reset();"
                                class="flex-1 bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- WebSocket connection for real-time updates -->
<script>
    // Connect to WebSocket for real-time job updates
    const socket = io();

    socket.on('connect', function() {
        console.log('Connected to WebSocket');
    });

    socket.on('job_update', function(data) {
        console.log('Job update received:', data);
        // Update the specific job card with new progress
        const jobCard = document.querySelector(`[data-job-id="${data.job_id}"]`);
        if (jobCard) {
            // Update progress bar
            const progressBar = jobCard.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = data.percent + '%';
                progressBar.textContent = data.percent + '%';
            }

            // Update status badge if status changed
            if (data.status) {
                const statusBadge = jobCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = 'status-badge px-3 py-1 rounded-full text-sm font-semibold ' + getStatusClass(data.status);
                    statusBadge.textContent = data.status;
                }
            }

            // Update transfer info
            if (data.bytes_transferred !== undefined) {
                const transferInfo = jobCard.querySelector('.transfer-info');
                if (transferInfo) {
                    transferInfo.textContent = formatBytes(data.bytes_transferred) + ' / ' + formatBytes(data.total_bytes);
                }
            }

            // Update speed
            if (data.speed_bytes !== undefined) {
                const speedInfo = jobCard.querySelector('.speed-info');
                if (speedInfo) {
                    speedInfo.textContent = formatBytes(data.speed_bytes) + '/s';
                }
            }

            // Update ETA
            if (data.eta_seconds !== undefined) {
                const etaInfo = jobCard.querySelector('.eta-info');
                if (etaInfo) {
                    etaInfo.textContent = 'ETA: ' + formatDuration(data.eta_seconds);
                }
            }

            // Update deletion progress
            if (data.deletion && data.deletion.enabled) {
                const deletionProgress = jobCard.querySelector('.deletion-progress');
                if (deletionProgress) {
                    const phaseText = deletionProgress.querySelector('.deletion-phase-text');
                    const filesCount = deletionProgress.querySelector('.deletion-files-count');
                    const bytesCount = deletionProgress.querySelector('.deletion-bytes-count');

                    // Update phase-specific text
                    if (phaseText) {
                        let phaseHtml = '';
                        const phase = data.deletion.phase;

                        if (phase === 'transfer') {
                            phaseHtml = '<span class="text-yellow-700">Transferring files...</span>';
                        } else if (phase === 'verifying') {
                            phaseHtml = '<span class="text-blue-700">üîç Verifying backup integrity...</span>';
                        } else if (phase === 'deleting') {
                            const files = data.deletion.files_deleted || 0;
                            const mb = (data.deletion.bytes_deleted / 1024 / 1024).toFixed(2) || '0.00';
                            phaseHtml = `<span class="text-red-700">üóëÔ∏è Deleting source files... (${files} files, ${mb} MB)</span>`;
                        } else if (phase === 'completed') {
                            const files = data.deletion.files_deleted || 0;
                            phaseHtml = `<span class="text-green-700">‚úÖ Deletion completed (${files} files deleted)</span>`;
                        } else if (phase === 'failed') {
                            phaseHtml = '<span class="text-red-700">‚ùå Deletion failed</span>';
                        }

                        phaseText.innerHTML = phaseHtml;
                    }

                    // Update counters separately if they exist (for deleting phase)
                    if (filesCount && data.deletion.files_deleted !== undefined) {
                        filesCount.textContent = data.deletion.files_deleted;
                    }
                    if (bytesCount && data.deletion.bytes_deleted !== undefined) {
                        bytesCount.textContent = (data.deletion.bytes_deleted / 1024 / 1024).toFixed(2);
                    }
                }
            }
        }
    });

    function getStatusClass(status) {
        const statusClasses = {
            'pending': 'bg-gray-200 text-gray-700',
            'running': 'bg-blue-100 text-blue-700',
            'paused': 'bg-yellow-100 text-yellow-700',
            'completed': 'bg-green-100 text-green-700',
            'failed': 'bg-red-100 text-red-700'
        };
        return statusClasses[status] || 'bg-gray-200 text-gray-700';
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function formatDuration(seconds) {
        if (seconds === 0) return '0s';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return h + 'h ' + m + 'm';
        if (m > 0) return m + 'm ' + s + 's';
        return s + 's';
    }
</script>
{% endblock %}

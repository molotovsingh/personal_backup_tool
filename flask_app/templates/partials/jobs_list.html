{% if jobs %}
<div id="jobs-list" class="space-y-3">
    {% for job in jobs %}
    {% set is_running = job.status == 'running' %}
    {% set is_first_non_running = loop.index == 1 and not is_running %}
    {% set default_expanded = is_running or is_first_non_running %}

    <div data-job-id="{{ job.id }}"
         x-data="{
             expanded: localStorage.getItem('job_{{ job.id }}_expanded') !== null
                 ? localStorage.getItem('job_{{ job.id }}_expanded') === 'true'
                 : {{ 'true' if default_expanded else 'false' }},
             toggle() {
                 this.expanded = !this.expanded;
                 localStorage.setItem('job_{{ job.id }}_expanded', this.expanded);
             }
         }"
         class="bg-white rounded-lg shadow hover:shadow-lg transition cursor-pointer"
         @click="toggle()">

        <!-- Collapsed View (Always Visible) -->
        <div class="p-4 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 flex-1 min-w-0">
                <!-- Expand/Collapse Button -->
                <button type="button" class="text-gray-400 hover:text-gray-600 flex-shrink-0" @click.stop="toggle()">
                    <span x-show="!expanded">‚ñ∂</span>
                    <span x-show="expanded">‚ñº</span>
                </button>

                <!-- Job Name -->
                <h3 class="font-bold text-gray-800 truncate" :class="expanded ? 'text-lg' : 'text-base'">
                    {{ job.name }}
                </h3>

                <!-- Status Badge -->
                <span class="status-badge px-2 py-1 rounded-full text-xs font-semibold flex-shrink-0
                    {% if job.status == 'pending' %}bg-gray-200 text-gray-700
                    {% elif job.status == 'running' %}bg-blue-100 text-blue-700
                    {% elif job.status == 'paused' %}bg-yellow-100 text-yellow-700
                    {% elif job.status == 'completed' %}bg-green-100 text-green-700
                    {% elif job.status == 'failed' %}bg-red-100 text-red-700
                    {% endif %}">
                    {{ job.status }}
                </span>

                <!-- Inline Progress (for running jobs, when collapsed) -->
                {% if job.status == 'running' %}
                <div x-show="!expanded" class="flex items-center gap-2 text-sm text-gray-600 flex-shrink-0">
                    <span class="font-semibold">{{ job.progress.percent }}%</span>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: {{ job.progress.percent }}%"></div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Quick Actions (Always Visible) -->
            <div class="flex gap-2 flex-shrink-0" @click.stop>
                {% if job.status in ['pending', 'paused', 'failed'] %}
                <button hx-post="/jobs/{{ job.id }}/start"
                        hx-target="#jobs-content"
                        hx-swap="outerHTML"
                        class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition text-xs font-medium">
                    ‚ñ∂
                </button>
                {% elif job.status == 'running' %}
                <button hx-post="/jobs/{{ job.id }}/pause"
                        hx-target="#jobs-content"
                        hx-swap="outerHTML"
                        class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700 transition text-xs font-medium">
                    ‚è∏
                </button>
                {% endif %}

                {% if job.status != 'running' %}
                <button hx-delete="/jobs/{{ job.id }}/delete"
                        hx-target="#jobs-content"
                        hx-swap="outerHTML"
                        hx-confirm="Delete '{{ job.name }}'? This cannot be undone."
                        class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition text-xs font-medium">
                    üóë
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Expanded View (Details) -->
        <div x-show="expanded"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 -translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-2"
             class="px-4 pb-4 border-t border-gray-100"
             @click.stop>

            <!-- Job Details -->
            <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs font-mono">{{ job.type }}</span>
                    {% if job.settings.delete_source_after %}
                    <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold">
                        üóëÔ∏è Deletion Enabled
                    </span>
                    {% endif %}
                </div>
                <p class="text-gray-600">
                    <span class="font-semibold">Source:</span> <span class="font-mono text-xs">{{ job.source }}</span>
                </p>
                <p class="text-gray-600">
                    <span class="font-semibold">Dest:</span> <span class="font-mono text-xs">{{ job.dest }}</span>
                </p>
            </div>

            <!-- Progress Bar (for running/paused jobs with progress) -->
            {% if job.status in ['running', 'paused'] or job.progress.percent > 0 %}
            <div class="mt-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span class="transfer-info">
                        {{ (job.progress.bytes_transferred / 1024 / 1024) | round(2) }} MB / {{ (job.progress.total_bytes / 1024 / 1024) | round(2) }} MB
                    </span>
                    <span class="font-semibold">{{ job.progress.percent }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div class="progress-bar bg-blue-600 h-4 rounded-full transition-all duration-500 flex items-center justify-center text-xs text-white font-semibold"
                         style="width: {{ job.progress.percent }}%">
                        {% if job.progress.percent > 10 %}{{ job.progress.percent }}%{% endif %}
                    </div>
                </div>
            </div>

            <!-- Transfer Stats (only for running jobs) -->
            {% if job.status == 'running' %}
            <div class="mt-3 grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="text-gray-600">Speed:</span>
                    <span class="speed-info font-semibold ml-1">
                        {{ (job.progress.speed_bytes / 1024) | round(2) }} KB/s
                    </span>
                </div>
                <div>
                    <span class="text-gray-600 eta-info">
                        ETA: {% if job.progress.eta_seconds > 0 %}{{ (job.progress.eta_seconds / 60) | round(1) }} min{% else %}calculating...{% endif %}
                    </span>
                </div>
            </div>

            <!-- Deletion Progress (if deletion is active) -->
            {% if job.progress.deletion and job.progress.deletion.enabled %}
            <div class="deletion-progress mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="text-sm">
                    <span class="font-semibold text-yellow-900">Deletion Phase:</span>
                    <span class="deletion-phase-text">
                    {% if job.progress.deletion.phase == 'transfer' %}
                        <span class="text-yellow-700">Transferring files...</span>
                    {% elif job.progress.deletion.phase == 'verifying' %}
                        <span class="text-blue-700">üîç Verifying backup integrity...</span>
                    {% elif job.progress.deletion.phase == 'deleting' %}
                        <span class="text-red-700">üóëÔ∏è Deleting source files... (<span class="deletion-files-count">{{ job.progress.deletion.files_deleted }}</span> files, <span class="deletion-bytes-count">{{ (job.progress.deletion.bytes_deleted / 1024 / 1024) | round(2) }}</span> MB)</span>
                    {% elif job.progress.deletion.phase == 'completed' %}
                        <span class="text-green-700">‚úÖ Deletion completed (<span class="deletion-files-count">{{ job.progress.deletion.files_deleted }}</span> files deleted)</span>
                    {% elif job.progress.deletion.phase == 'failed' %}
                        <span class="text-red-700">‚ùå Deletion failed</span>
                    {% endif %}
                    </span>
                </div>
            </div>
            {% endif %}
            {% endif %}
            {% endif %}

            <!-- Job Settings Info -->
            <div class="mt-4 pt-3 border-t border-gray-200">
                <div class="grid grid-cols-2 gap-4 text-xs text-gray-600">
                    <div>
                        <span class="font-semibold">Bandwidth:</span>
                        {% if job.settings.bandwidth_limit %}{{ job.settings.bandwidth_limit }} KB/s{% else %}Unlimited{% endif %}
                    </div>
                    <div>
                        <span class="font-semibold">Created:</span>
                        {{ job.created_at[:10] }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div id="jobs-list" class="text-center py-12 bg-white rounded-lg shadow">
    <div class="text-gray-400 mb-4">
        <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No backup jobs yet</h3>
    <p class="text-gray-500 mb-4">Create your first backup job to get started</p>
</div>
{% endif %}
